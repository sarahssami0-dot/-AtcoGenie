
<div class="flex h-screen font-sans text-slate-800 dark:text-slate-300 bg-white dark:bg-slate-900 overflow-hidden">
  <!-- Left Panel: Chat History (Collapsible) -->
  <aside class="flex-shrink-0 bg-slate-100 dark:bg-slate-800 flex flex-col transition-all duration-300 ease-in-out border-r border-slate-200 dark:border-slate-700" [class]="isSidebarOpen() ? 'w-1/4 max-w-xs' : 'w-0 opacity-0 pointer-events-none'">
    <header class="p-3 flex items-center gap-2">
       <svg class="w-8 h-8" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <defs>
              <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#3b82f6"/> <!-- blue-500 -->
                  <stop offset="100%" stop-color="#a855f7"/> <!-- purple-500 -->
              </linearGradient>
          </defs>
          <path d="M50,16 C60,20 62,32 56,42 C50,52 38,58 28,54 C18,50 10,40 14,30 C18,20 30,12 40,14 Z" stroke="url(#logo-gradient)" stroke-width="2" fill="none" stroke-opacity="0.3"/>
          <path d="M48,18 C56,22 58,32 52,40 C46,48 36,52 28,48 C20,44 14,36 18,28 C22,20 32,16 40,18 Z" stroke="url(#logo-gradient)" stroke-width="2" fill="none" stroke-opacity="0.3"/>
          <path d="M42,26 C36.25,24.5 30.75,26.5 28,31 C25.25,35.5 25.5,41.5 29.5,45.5 C33.5,49.5 39.5,49.75 44,47 C48.5,44.25 50.5,38.75 49,33 L54,36 L51,30 C49.5,27.5 45,26.5 42,26 Z" fill="url(#logo-gradient)"/>
          <circle cx="20" cy="28" r="4" fill="url(#logo-gradient)"/><circle cx="44" cy="20" r="3" fill="url(#logo-gradient)"/><circle cx="52" cy="32" r="4" fill="url(#logo-gradient)"/><circle cx="46" cy="46" r="3" fill="url(#logo-gradient)"/><circle cx="26" cy="48" r="4" fill="url(#logo-gradient)"/><circle cx="16" cy="42" r="3" fill="url(#logo-gradient)"/>
          <g stroke="url(#logo-gradient)" stroke-width="1.5" stroke-linecap="round" stroke-opacity="0.6">
              <path d="M22 28 L 38 23"/><path d="M44 23 L 50 31"/><path d="M52 35 L 47 45"/><path d="M44 46 L 29 48"/><path d="M25 46 L 17 42"/><path d="M18 40 L 22 30"/>
          </g>
      </svg>
       <h1 class="text-lg font-bold text-slate-800 dark:text-slate-200">ATCO Genie</h1>
    </header>
    <div class="p-3">
      <button (click)="startNewChat()" class="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
        New Chat
      </button>
    </div>

    <!-- Company Selector -->
    <div class="px-3 pb-3 border-b border-slate-200 dark:border-slate-700" #companySelectorContainer>
      <p class="mb-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Company</p>
      <div class="relative">
        <button (click)="toggleCompanySelector()" type="button" class="w-full flex items-center justify-between text-left text-sm font-medium bg-white dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 transition-colors hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200">
            <span class="flex items-center gap-2 truncate">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375a.75.75 0 01.75.75v3.75a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V7.5a.75.75 0 01.75-.75z" /></svg>
              <span class="truncate">{{ companySelectorText() }}</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
        </button>
        @if (isCompanySelectorOpen()) {
          <div class="absolute top-full mt-1 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-xl z-20 overflow-hidden">
              <ul class="max-h-60 overflow-y-auto">
                  @for (company of availableCompanies; track company.id) {
                      <li>
                          <label class="flex items-center w-full gap-3 p-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                            <input type="checkbox" 
                                    [checked]="isCompanySelected(company.id)"
                                    (change)="toggleCompanySelection(company.id)"
                                    class="h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-blue-600 focus:ring-blue-500 bg-white dark:bg-slate-700">
                            <span class="text-sm font-medium text-slate-800 dark:text-slate-200 flex-1">
                              {{ company.name }}
                            </span>
                          </label>
                      </li>
                  }
              </ul>
          </div>
        }
      </div>
    </div>

    <nav class="flex-1 flex flex-col overflow-y-auto p-2">
      <div class="px-1 pt-1 pb-2">
        <p class="mb-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Chat History</p>
        <div class="relative">
          <input type="text" [(ngModel)]="chatSearchTerm" placeholder="Search chats..." class="w-full bg-white dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 rounded-md pl-8 pr-3 py-1.5 text-sm text-slate-800 dark:text-slate-200 placeholder-slate-500 dark:placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-2 top-1/2 -translate-y-1/2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>
      </div>
      <ul class="flex-1 overflow-y-auto">
        @for (session of filteredChatHistory(); track session.id) {
          <li class="mb-1 group relative">
            <button (click)="selectSession(session.id)" 
                    class="w-full text-left p-2.5 rounded-lg transition-colors duration-200 flex justify-between items-center"
                    [class]="session.id === selectedSessionId() ? 'bg-slate-200 dark:bg-slate-700' : 'hover:bg-slate-200/50 dark:hover:bg-slate-700/50'">
              
              @if (renamingSessionId() === session.id) {
                <input #renameInput type="text" [value]="session.title"
                       (blur)="saveRename(session, renameInput.value)"
                       (keydown.enter)="saveRename(session, renameInput.value); renameInput.blur()"
                       (keydown.escape)="cancelRename()"
                       (click)="$event.stopPropagation()"
                       class="w-full bg-white dark:bg-slate-600 text-sm font-semibold text-slate-800 dark:text-slate-200 rounded border border-blue-500 ring-1 ring-blue-500 focus:outline-none px-1 py-0.5 -m-1">
              } @else {
                <span class="font-semibold text-sm text-slate-600 dark:text-slate-300 truncate pr-2">{{ session.title }}</span>
              }

              <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity" [class]="renamingSessionId() === session.id ? 'opacity-100' : ''">
                 <button (click)="toggleChatMenu(session.id, $event)" class="p-1 rounded hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-500 dark:text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                 </button>
              </div>
            </button>
            @if (openChatMenuId() === session.id) {
              <div class="absolute right-2 top-10 w-40 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md shadow-lg z-20 py-1">
                <button (click)="startRenaming(session.id, $event, renameInput)" class="w-full flex items-center gap-2 text-left px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                  Rename
                </button>
                 <button (click)="archiveSession(session.id); $event.stopPropagation()" class="w-full flex items-center gap-2 text-left px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                  Archive
                </button>
                <button (click)="deleteSession(session.id); $event.stopPropagation()" class="w-full flex items-center gap-2 text-left px-3 py-1.5 text-sm text-rose-600 dark:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-500/10">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                  Delete
                </button>
              </div>
            }
          </li>
        }
      </ul>
    </nav>
    <footer class="p-3 border-t border-slate-200 dark:border-slate-700">
        <button class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <div class="w-10 h-10 rounded-full bg-fuchsia-600 flex items-center justify-center font-bold text-slate-100 flex-shrink-0">
                {{ user().avatar }}
            </div>
            <div class="flex-1 text-left overflow-hidden">
                <h4 class="font-semibold text-sm text-slate-800 dark:text-slate-200 truncate">{{ user().name }}</h4>
                <p class="text-xs text-slate-500 dark:text-slate-400 truncate">{{ user().role }}</p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
        </button>
    </footer>
  </aside>

  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Navigation Bar -->
    <header class="flex-shrink-0 flex items-center justify-between p-3 border-b border-slate-200 dark:border-slate-700">
        <button (click)="toggleSidebar()" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex items-center gap-2">
            <svg class="w-7 h-7" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><use href="#logo-gradient" /><path d="M50,16 C60,20 62,32 56,42 C50,52 38,58 28,54 C18,50 10,40 14,30 C18,20 30,12 40,14 Z" stroke="url(#logo-gradient)" stroke-width="2" fill="none" stroke-opacity="0.3"/><path d="M48,18 C56,22 58,32 52,40 C46,48 36,52 28,48 C20,44 14,36 18,28 C22,20 32,16 40,18 Z" stroke="url(#logo-gradient)" stroke-width="2" fill="none" stroke-opacity="0.3"/><path d="M42,26 C36.25,24.5 30.75,26.5 28,31 C25.25,35.5 25.5,41.5 29.5,45.5 C33.5,49.5 39.5,49.75 44,47 C48.5,44.25 50.5,38.75 49,33 L54,36 L51,30 C49.5,27.5 45,26.5 42,26 Z" fill="url(#logo-gradient)"/><circle cx="20" cy="28" r="4" fill="url(#logo-gradient)"/><circle cx="44" cy="20" r="3" fill="url(#logo-gradient)"/><circle cx="52" cy="32" r="4" fill="url(#logo-gradient)"/><circle cx="46" cy="46" r="3" fill="url(#logo-gradient)"/><circle cx="26" cy="48" r="4" fill="url(#logo-gradient)"/><circle cx="16" cy="42" r="3" fill="url(#logo-gradient)"/><g stroke="url(#logo-gradient)" stroke-width="1.5" stroke-linecap="round" stroke-opacity="0.6"><path d="M22 28 L 38 23"/><path d="M44 23 L 50 31"/><path d="M52 35 L 47 45"/><path d="M44 46 L 29 48"/><path d="M25 46 L 17 42"/><path d="M18 40 L 22 30"/></g></svg>
            <h2 class="text-lg font-bold text-slate-800 dark:text-slate-200">ATCO Genie</h2>
        </div>
        <button (click)="toggleTheme()" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
            @if(theme() === 'dark') {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            }
        </button>
    </header>

    <!-- Chat Screen -->
    <main class="flex-1 flex flex-col overflow-hidden">
      @if (isNewChatView()) {
        <div class="flex-1 flex flex-col justify-center items-center text-center p-6 min-h-0">
          <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mb-4 text-white shadow-lg p-2">
            <svg class="w-full h-full" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><use href="#logo-gradient" /><path d="M50,16 C60,20 62,32 56,42 C50,52 38,58 28,54 C18,50 10,40 14,30 C18,20 30,12 40,14 Z" stroke="#fff" stroke-width="2" fill="none" stroke-opacity="0.3"/><path d="M48,18 C56,22 58,32 52,40 C46,48 36,52 28,48 C20,44 14,36 18,28 C22,20 32,16 40,18 Z" stroke="#fff" stroke-width="2" fill="none" stroke-opacity="0.3"/><path d="M42,26 C36.25,24.5 30.75,26.5 28,31 C25.25,35.5 25.5,41.5 29.5,45.5 C33.5,49.5 39.5,49.75 44,47 C48.5,44.25 50.5,38.75 49,33 L54,36 L51,30 C49.5,27.5 45,26.5 42,26 Z" fill="#fff"/><circle cx="20" cy="28" r="4" fill="#fff"/><circle cx="44" cy="20" r="3" fill="#fff"/><circle cx="52" cy="32" r="4" fill="#fff"/><circle cx="46" cy="46" r="3" fill="#fff"/><circle cx="26" cy="48" r="4" fill="#fff"/><circle cx="16" cy="42" r="3" fill="#fff"/><g stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-opacity="0.6"><path d="M22 28 L 38 23"/><path d="M44 23 L 50 31"/><path d="M52 35 L 47 45"/><path d="M44 46 L 29 48"/><path d="M25 46 L 17 42"/><path d="M18 40 L 22 30"/></g></svg>
          </div>
          <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-200">ATCO Genie</h1>
          <p class="text-slate-500 dark:text-slate-400 mt-1">How can I help you today?</p>
        </div>
      } @else {
        <div #messageContainer class="flex-1 overflow-y-auto p-6 space-y-8 min-h-0">
          @for (message of currentChatMessages(); track message.id) {
            <div class="flex items-start gap-4 max-w-4xl mx-auto" [class]="message.sender === 'user' ? 'justify-end' : 'justify-start'">
              @if(message.sender === 'bot') {
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 p-1">
                  <svg class="w-full h-full" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><use href="#logo-gradient" /><path d="M50,16 C60,20 62,32 56,42 C50,52 38,58 28,54 C18,50 10,40 14,30 C18,20 30,12 40,14 Z" stroke="#fff" stroke-width="3" fill="none" stroke-opacity="0.3"/><path d="M48,18 C56,22 58,32 52,40 C46,48 36,52 28,48 C20,44 14,36 18,28 C22,20 32,16 40,18 Z" stroke="#fff" stroke-width="3" fill="none" stroke-opacity="0.3"/><path d="M42,26 C36.25,24.5 30.75,26.5 28,31 C25.25,35.5 25.5,41.5 29.5,45.5 C33.5,49.5 39.5,49.75 44,47 C48.5,44.25 50.5,38.75 49,33 L54,36 L51,30 C49.5,27.5 45,26.5 42,26 Z" fill="#fff"/><circle cx="20" cy="28" r="4" fill="#fff"/><circle cx="44" cy="20" r="3" fill="#fff"/><circle cx="52" cy="32" r="4" fill="#fff"/><circle cx="46" cy="46" r="3" fill="#fff"/><circle cx="26" cy="48" r="4" fill="#fff"/><circle cx="16" cy="42" r="3" fill="#fff"/><g stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-opacity="0.6"><path d="M22 28 L 38 23"/><path d="M44 23 L 50 31"/><path d="M52 35 L 47 45"/><path d="M44 46 L 29 48"/><path d="M25 46 L 17 42"/><path d="M18 40 L 22 30"/></g></svg>
                </div>
              }
              <div class="flex-1 group max-w-3xl">
                  @if(message.sender === 'user') {
                    <div class="bg-blue-600 text-white p-3 rounded-xl rounded-br-none">
                      <p class="prose prose-invert prose-sm max-w-none whitespace-pre-wrap">{{ message.text }}</p>
                    </div>
                  } @else {
                    <div class="prose prose-sm max-w-none prose-slate dark:prose-invert" [innerHTML]="message.text"></div>
                    <div class="mt-2 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button (click)="copyMessage(message.text)" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                      </button>
                    </div>
                  }
              </div>
            </div>
          }
          @if (isBotTyping()) {
            <div class="flex items-start gap-4 max-w-4xl mx-auto">
              <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 p-1">
                 <svg class="w-full h-full" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><use href="#logo-gradient" /><path d="M50,16 C60,20 62,32 56,42 C50,52 38,58 28,54 C18,50 10,40 14,30 C18,20 30,12 40,14 Z" stroke="#fff" stroke-width="3" fill="none" stroke-opacity="0.3"/><path d="M48,18 C56,22 58,32 52,40 C46,48 36,52 28,48 C20,44 14,36 18,28 C22,20 32,16 40,18 Z" stroke="#fff" stroke-width="3" fill="none" stroke-opacity="0.3"/><path d="M42,26 C36.25,24.5 30.75,26.5 28,31 C25.25,35.5 25.5,41.5 29.5,45.5 C33.5,49.5 39.5,49.75 44,47 C48.5,44.25 50.5,38.75 49,33 L54,36 L51,30 C49.5,27.5 45,26.5 42,26 Z" fill="#fff"/><circle cx="20" cy="28" r="4" fill="#fff"/><circle cx="44" cy="20" r="3" fill="#fff"/><circle cx="52" cy="32" r="4" fill="#fff"/><circle cx="46" cy="46" r="3" fill="#fff"/><circle cx="26" cy="48" r="4" fill="#fff"/><circle cx="16" cy="42" r="3" fill="#fff"/><g stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-opacity="0.6"><path d="M22 28 L 38 23"/><path d="M44 23 L 50 31"/><path d="M52 35 L 47 45"/><path d="M44 46 L 29 48"/><path d="M25 46 L 17 42"/><path d="M18 40 L 22 30"/></g></svg>
              </div>
              <div class="pt-2">
                <div class="flex items-center justify-center space-x-1">
                  <span class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                  <span class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                  <span class="w-2 h-2 bg-slate-400 dark:bg-slate-500 rounded-full animate-pulse"></span>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <!-- Input Form -->
      <div class="px-6 pb-6 w-full max-w-4xl mx-auto flex-shrink-0">
          <form (ngSubmit)="sendMessage()" (keydown)="handleEnter($event)" class="relative bg-white dark:bg-slate-900 border border-black dark:border-slate-500 rounded-xl p-2">
              <textarea #promptTextarea [(ngModel)]="currentUserInput" name="messageInput"
                        (input)="autoResizeTextarea()"
                        placeholder="Ask anything, or use the mic to speak..."
                        class="w-full bg-transparent pl-2 pr-24 py-3 text-slate-800 dark:text-slate-300 placeholder-slate-500 dark:placeholder-slate-500 resize-none focus:outline-none max-h-50" rows="1"></textarea>
              
              <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                   <button (click)="toggleVoiceRecognition()" type="button" class="p-2 rounded-md transition-colors" [class]="isRecording() ? 'text-red-500 bg-red-500/10 animate-pulse' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 016 0v8.25a3 3 0 01-3 3z" />
                      </svg>
                  </button>
                  <button type="submit" [disabled]="!currentUserInput()" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center transition-colors hover:bg-blue-700 disabled:opacity-50 disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                      </svg>
                  </button>
              </div>
              
              <div class="flex items-center gap-1 pl-1">
                  <input type="file" #fileInput class="hidden" (change)="onFileSelected($event)">
                  <button type="button" (click)="triggerFileInput()" class="p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                      </svg>
                  </button>
                  <div #modelSelectorContainer class="relative">
                      <button type="button" (click)="isModelSelectorOpen.set(!isModelSelectorOpen())" class="flex items-center gap-1.5 p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                          <span class="text-sm font-medium text-slate-700 dark:text-slate-300">{{ selectedModel().name }}</span>
                      </button>
                      @if (isModelSelectorOpen()) {
                          <div class="absolute bottom-full mb-2 w-60 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-xl overflow-hidden z-10">
                              @for(model of availableModels; track model.id) {
                                  <button (click)="setModel(model.id)" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-600 flex items-center justify-between" [class]="model.id === selectedModel().id ? 'bg-blue-600 hover:bg-blue-600 text-white' : 'text-slate-700 dark:text-slate-300'">
                                      <span>{{ model.name }} <span class="text-xs opacity-70">({{ model.quality }})</span></span>
                                      @if(model.id === selectedModel().id) { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
                                  </button>
                              }
                          </div>
                      }
                  </div>
                  @if (isRecording()) {
                    <span class="text-xs text-red-500 animate-pulse">Listening...</span>
                  }
              </div>
          </form>
      </div>
    </main>
  </div>
</div>